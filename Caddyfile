# Updated Caddy configuration to integrate with existing new.transcend.money setup
# Add this to your existing new.transcend.money block:

new.transcend.money {
    # Handle the /warzone path for the crypto war zone app
    handle /warzone* {
        # Reverse proxy to your Node.js app running on port 3005
        # CRITICAL: WebSocket support with proper headers
        reverse_proxy localhost:3005 {
            # Enable WebSocket support
            header_up Host {host}
            header_up X-Real-IP {remote}
            header_up X-Forwarded-For {remote}
            header_up X-Forwarded-Proto {scheme}
            
            # WebSocket upgrade headers (critical for Socket.IO)
            header_up Connection {>Connection}
            header_up Upgrade {>Upgrade}
            header_up Sec-WebSocket-Key {>Sec-WebSocket-Key}
            header_up Sec-WebSocket-Version {>Sec-WebSocket-Version}
            header_up Sec-WebSocket-Extensions {>Sec-WebSocket-Extensions}
            header_up Sec-WebSocket-Protocol {>Sec-WebSocket-Protocol}
            
            # CRITICAL: Transport configuration for Socket.IO WebSocket
            transport http {
                keepalive 30s
                versions h2c 1.1
            }
        }
        
        # Add security headers (but not for WebSocket connections)
        header {
            # Security headers
            X-Content-Type-Options nosniff
            X-Frame-Options DENY
            X-XSS-Protection "1; mode=block"
            Referrer-Policy strict-origin-when-cross-origin
            
            # CORS headers for WebSocket and API
            Access-Control-Allow-Origin "*"
            Access-Control-Allow-Methods "GET, POST, OPTIONS, UPGRADE"
            Access-Control-Allow-Headers "Content-Type, Authorization, Upgrade, Connection"
        }
        
        # Enable compression (but not for WebSocket)
        encode gzip
        
        # Log requests for warzone specifically
        log {
            output file /var/log/caddy/warzone.log
            format json
        }
    }
    
    # Your existing configuration for the main site
    # Set this path to your site's directory.
    root * /var/www/html/landing

    encode gzip
    try_files {path} index.html
    # Enable the static file server.
    file_server

    log {
        output file /var/log/caddy/access_new.log
        format json
    }
}
